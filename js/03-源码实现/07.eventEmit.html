<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>狂奔的小球</title>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #box{
            position: absolute;
            top: 100px;
            left: 100px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: lightcoral;
            cursor: move;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div id="box"></div>
<script type="text/javascript" src="jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="subscrible.js"></script>
<script type="text/javascript">
    //drag.js
    class Drag {
        //ele为传入的DOM对象
        constructor(ele) {
                //初始化参数
            this.ele = ele;
            this.strX = null;
            this.strY = null;
            this.strL = null;
            this.strT = null;
            this.curL = null;
            this.curT = null;

            this.subDown = new Subscribe()
            this.subMove = new Subscribe()
            this.subUp = new Subscribe()

            //为按下鼠标绑定事件,事件函数一定要绑定this,在封装过程中this统一指定为实例对象，下不赘述
            this.DOWN = this.down.bind(this);
            this.ele.addEventListener('mousedown', this.DOWN);
        }
        down(ev) {
            let ele = this.ele;
            this.strX = ev.clientX;//鼠标点击处到浏览器窗口最左边的距离
            this.strY = ev.clientY;//鼠标点击处到浏览器窗口最上边的距离
            this.strL = ele.offsetLeft;//元素到浏览器窗口最左边的距离
            this.strT = ele.offsetTop;//元素到浏览器窗口最上边的距离
        
            this.MOVE = this.move.bind(this);
            this.UP = this.up.bind(this);
            document.addEventListener('mousemove', this.MOVE);
            document.addEventListener('mouseup', this.UP);
            
            this.subDown.fire(ele, ev);
        }
        move(ev) {
            let ele = this.ele;
            this.curL = ev.clientX - this.strX + this.strL;
            this.curT = ev.clientY - this.strY + this.strT;
            ele.style.left = this.curL + 'px';
            ele.style.top = this.curT + 'px';
            
            this.subMove.fire(ele, ev);
        }
        up(ev) {
            //给前两个事件解绑
            document.removeEventListener('mousemove', this.MOVE);
            document.removeEventListener('mouseup', this.UP);
            
            this.subUp.fire(this.ele, ev)
        }
    }
    window.Drag = Drag;
    var box = document.querySelector('#box')
    let drag = new Drag(box);
    extendDrag(drag);

    function extendDrag(drag) {
        let stopAnimate = function stopAnimate(curEle) {
            clearInterval(curEle.flyTimer);
            curEle.speedFly = undefined;
            clearInterval(curEle.dropTimer);
        };
         //鼠标移动
        let computedFly = function computedFly(curEle) {
            if (!curEle.lastFly) {
                curEle.lastFly = curEle.offsetLeft;
                curEle.speedFly = 0;
                return;
            }
            curEle.speedFly = curEle.offsetLeft - curEle.lastFly;
            curEle.lastFly = curEle.offsetLeft;
        };
        //水平方向的运动
        let animateFly = function animateFly(curEle) {
            let minL = 0,
                maxL = document.documentElement.clientWidth - curEle.offsetWidth,
                speed = curEle.speedFly;
            curEle.flyTimer = setInterval(() => {
                speed *= .98;
                Math.abs(speed) <= 0.1 ? clearInterval(animateFly):null;
                let curT = curEle.offsetLeft;
                curT += speed;
                if (curT >= maxL) {
                    curEle.style.left = maxL + 'px';
                    speed *= -1;
                    return;
                }
                if (curT <= minL) {
                    curEle.style.left = minL + 'px';
                    speed *= -1;
                    return;
                }
                curEle.style.left = curT + 'px';
            }, 20);
        };
        //竖直方向的运动
        let animateDrop = function animateDrop(curEle) {
            let speed = 9.8,
                minT = 0,
                maxT = document.documentElement.clientHeight - curEle.offsetHeight;
            curEle.dropTimer = setInterval(() => {
                speed += 10;
                speed *= .98;
                Math.abs(speed) <= 0.1 ? clearInterval(animateFly):null;
                let curT = curEle.offsetTop;
                curT += speed;
                if (curT >= maxT) {
                    curEle.style.top = maxT + 'px';
                    speed *= -1;
                    return;
                }
                if (curT <= minT) {
                    curEle.style.top = minT + 'px';
                    speed *= -1;
                    return;
                }
                curEle.style.top = curT + 'px';
            }, 20);
        }

        drag.subDown.add(stopAnimate);
        drag.subMove.add(computedFly);
        drag.subUp.add(animateFly);
        drag.subUp.add(animateDrop);
    }

    // jQuery现成的发布订阅方法
    // 开辟一个容器
    console.dir($)
    let $plan =  $.Callbacks();
    function fn1(x, y) {
        console.log(x, y);
    }
    function fn2(x, y) {
        console.log(y, x);
    }
    //往容器里面添加函数
    $plan.add(fn1)
    $plan.add(fn2)
    $plan.remove(fn2);
    $plan.fire(10, 20);//会输出10，20 20,10
    //用来从容器中删除某个函数

    

    var sub = new Subscribe()
    let fun1 = function fun1(x, y) {
        console.log(1, x, y);
    };
    let fun2 = function fun2() {
        console.log(2);
    };
    let fun3 = function fn3() {
        console.log(3);
        sub.remove(fun1);
        sub.remove(fun2);
    };

    sub.add(fun1)
    sub.add(fun2)
    sub.add(fun3)
    setInterval(() => {
        sub.fire(100, 200)
    }, 1000)
</script>
</body>
</html>